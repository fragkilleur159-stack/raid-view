<script>
  // ‚öôÔ∏è CONFIG : adapte cette URL √† celle de ton API Render
  // Exemple : https://raid-api-xxxxx.onrender.com
  // ATTENTION : ici c'est juste la "base", SANS /raid/state √† la fin
  const API_BASE = "https://raid-api-la5d.onrender.com";
  const STATE_ENDPOINT = API_BASE + "/raid/state";

  let prevState = null;
  let lastAttackAnimationTimeout = null;

  function formatNumber(n) {
    return (n || 0).toLocaleString("fr-FR");
  }

  function starsLabel(stars) {
    stars = Number(stars) || 0;
    const s = "‚≠ê".repeat(Math.max(1, Math.min(4, stars)));
    switch (stars) {
      case 2: return s + " (Facile)";
      case 3: return s + " (Normal)";
      case 4: return s + " (Difficile)";
      default: return s;
    }
  }

  function pickEmojiFromName(name) {
    if (!name) return "‚öîÔ∏è";
    const code = name.split("").reduce((acc, ch) => acc + ch.charCodeAt(0), 0);
    const emojis = ["üê≤", "üêâ", "üëπ", "üíÄ", "üî•", "‚öîÔ∏è", "üßü", "ü¶Ç", "üê∫", "ü¶á"];
    return emojis[code % emojis.length];
  }

  function formatTimer(startTs, endTs, status) {
    const now = Date.now() / 1000;
    if (!startTs || !endTs) return "";
    const total = endTs - startTs;
    const elapsed = now - startTs;
    const remaining = endTs - now;

    if (status === "finished" || remaining <= 0) {
      return "‚è± Termin√©";
    }

    const totalMin = Math.round(total / 60);
    const elapsedMin = Math.max(0, Math.round(elapsed / 60));
    const remainMin = Math.max(0, Math.round(remaining / 60));

    return `‚è± ${elapsedMin} min / ${totalMin} min (reste ~${remainMin} min)`;
  }

  function updateBossView(data) {
    const bossNameEl = document.getElementById("boss-name");
    const bossStarsEl = document.getElementById("boss-stars");
    const hpTextEl = document.getElementById("hp-text");
    const hpFillEl = document.getElementById("hp-fill");
    const hpWrapperEl = document.getElementById("hp-wrapper");
    const diffLabelEl = document.getElementById("difficulty-label");
    const timerStatusEl = document.getElementById("timer-status");
    const timerRangeEl = document.getElementById("timer-range");
    const bossEmojiEl = document.getElementById("boss-emoji");

    if (!data || data.status !== "running") {
      bossNameEl.textContent = "Aucun raid actif";
      bossStarsEl.textContent = "";
      hpTextEl.textContent = "0 / 0";
      hpFillEl.style.transform = "scaleX(0)";
      diffLabelEl.textContent = "";
      timerStatusEl.textContent = "Le raid est termin√© ou inactif.";
      timerRangeEl.textContent = "";
      bossEmojiEl.textContent = "üí§";
      return;
    }

    const bossName = data.boss || "Boss inconnu";
    const hpCur = Number(data.hp_current) || 0;
    const hpMax = Math.max(1, Number(data.hp_max) || 1);
    const stars = Number(data.stars) || 0;
    const startTs = Number(data.start || 0);
    const endTs = Number(data.end || 0);

    bossNameEl.textContent = bossName;
    bossStarsEl.textContent = "‚≠ê".repeat(Math.max(1, Math.min(4, stars)));
    bossEmojiEl.textContent = bossName.includes(" ") ? "‚öîÔ∏è" : pickEmojiFromName(bossName);

    hpTextEl.textContent = `${formatNumber(hpCur)} / ${formatNumber(hpMax)}`;

    const ratio = Math.max(0, Math.min(1, hpCur / hpMax));
    hpFillEl.style.transform = `scaleX(${ratio})`;

    diffLabelEl.textContent = starsLabel(stars);
    timerStatusEl.textContent = formatTimer(startTs, endTs, data.status);
    if (startTs && endTs) {
      const startDate = new Date(startTs * 1000);
      const endDate = new Date(endTs * 1000);
      timerRangeEl.textContent = `Du ${startDate.toLocaleString("fr-FR")} au ${endDate.toLocaleString("fr-FR")}`;
    } else {
      timerRangeEl.textContent = "";
    }

    // Animation boss frapp√© : si les PV ont baiss√© depuis la derni√®re frame
    if (prevState && prevState.status === "running") {
      const prevCur = Number(prevState.hp_current) || 0;
      if (hpCur < prevCur) {
        hpWrapperEl.classList.remove("boss-hit");
        void hpWrapperEl.offsetWidth; // force reflow
        hpWrapperEl.classList.add("boss-hit");
      }
    }
  }

  function updateParticipantsView(data) {
    const listEl = document.getElementById("participants-list");
    const emptyEl = document.getElementById("participants-empty");
    const countEl = document.getElementById("participants-count");

    const participants = (data && Array.isArray(data.participants))
      ? data.participants.slice()
      : [];

    if (participants.length === 0) {
      listEl.innerHTML = "";
      emptyEl.style.display = "block";
      countEl.textContent = "0 joueurs";
      return;
    }

    emptyEl.style.display = "none";
    countEl.textContent = `${participants.length} joueur(s)`;

    participants.sort((a, b) => (b.damage || 0) - (a.damage || 0));

    let maxDmg = 0;
    for (const p of participants) {
      if ((p.damage || 0) > maxDmg) {
        maxDmg = p.damage || 0;
      }
    }
    if (maxDmg <= 0) maxDmg = 1;

    listEl.innerHTML = "";
    participants.forEach((p, idx) => {
      const row = document.createElement("div");
      row.className = "participant-row";

      const dmgRatio = Math.max(0, Math.min(1, (p.damage || 0) / maxDmg));

      const colorClass =
        idx === 0 ? "participant-rank-1"
        : idx === 1 ? "participant-rank-2"
        : idx === 2 ? "participant-rank-3"
        : "";

      if (colorClass) {
        row.classList.add(colorClass);
      }

      // Colonne 1 : pseudo + pet
      const col1 = document.createElement("div");
      const nameDiv = document.createElement("div");
      nameDiv.className = "participant-name";
      nameDiv.textContent = p.name || `Joueur #${idx + 1}`;

      const petDiv = document.createElement("div");
      petDiv.className = "participant-pet";
      petDiv.textContent = p.pet ? `Pet: ${p.pet}` : "";

      col1.appendChild(nameDiv);
      col1.appendChild(petDiv);

      // Colonne 2 : d√©g√¢ts + barre
      const col2 = document.createElement("div");
      col2.className = "participant-damage";

      const dmgText = document.createElement("div");
      dmgText.textContent = `${formatNumber(p.damage || 0)} dmg`;

      const barOuter = document.createElement("div");
      barOuter.className = "participant-bar-outer";

      const barInner = document.createElement("div");
      barInner.className = "participant-bar-inner";
      barInner.style.transform = `scaleX(${dmgRatio})`;

      barOuter.appendChild(barInner);
      col2.appendChild(dmgText);
      col2.appendChild(barOuter);

      row.appendChild(col1);
      row.appendChild(col2);
      listEl.appendChild(row);
    });
  }

  function updateStatusPill(data) {
    const pill = document.getElementById("status-pill");
    const textEl = document.getElementById("status-text");

    pill.classList.remove("status-idle", "status-running", "status-finished");

    if (!data) {
      pill.classList.add("status-idle");
      textEl.textContent = "Aucun raid";
      return;
    }

    switch (data.status) {
      case "running":
        pill.classList.add("status-running");
        textEl.textContent = "Raid en cours";
        break;
      case "finished":
        pill.classList.add("status-finished");
        textEl.textContent = "Raid termin√©";
        break;
      default:
        pill.classList.add("status-idle");
        textEl.textContent = "Aucun raid";
        break;
    }
  }

  function setLastUpdate() {
    const el = document.getElementById("last-update");
    const now = new Date();
    el.textContent = `Derni√®re mise √† jour : ${now.toLocaleTimeString("fr-FR")}`;
  }

  async function fetchRaidState() {
    try {
      const res = await fetch(STATE_ENDPOINT, { cache: "no-store" });
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      const data = await res.json();

      // data est d√©j√† exactement au bon format gr√¢ce √† main.py
      updateBossView(data);
      updateParticipantsView(data);
      updateStatusPill(data);
      setLastUpdate();

      prevState = data;
    } catch (err) {
      console.error("Erreur de r√©cup√©ration du raid:", err);
      updateBossView(null);
      updateParticipantsView(null);
      updateStatusPill(null);
    }
  }

  // Premier appel
  fetchRaidState();
  // Rafra√Æchissement toutes les 2 secondes
  setInterval(fetchRaidState, 2000);
</script>


